name: Test Azure Credentials

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  login-test:
    environment: dev
    runs-on: ubuntu-latest
    steps:
      - name: Log in to Azure using AZURE_CREDENTIALS
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          allow-no-subscriptions: true
          audience: 'api://AzureADTokenExchange'

      - name: Show account info
        shell: bash
        run: |
          echo "Azure CLI version:" $(az version --query 'azure-cli' -o tsv)
          echo "TenantId: $(az account show --query tenantId -o tsv 2>/dev/null || echo 'n/a')"
          echo "SubscriptionId: $(az account show --query id -o tsv 2>/dev/null || echo 'n/a')"

      - name: List subscriptions (may be empty)
        shell: bash
        run: |
          az account list --output table || true

      - name: Management plane probe (safe)
        shell: bash
        run: |
          # az resource list does not support --top; use JMESPath to return one row
          az resource list \
            --query "[0:1].{name:name,type:type,rg:resourceGroup,location:location}" \
            --output table || true

